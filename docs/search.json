[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Material on Survival Analyses",
    "section": "",
    "text": "Intro\nThe analyses you see here come from various courses related to survival analysis, epidemiology and causal inference:\n\nModern methods for analyzing survival and time to event data (2022) link\nCausal inference for time-to-event outcomes (2024) link"
  },
  {
    "objectID": "na_km_logrank.html#nelson-aalen-estimator",
    "href": "na_km_logrank.html#nelson-aalen-estimator",
    "title": "Non-parametric estimators",
    "section": "Nelson-Aalen estimator",
    "text": "Nelson-Aalen estimator\n\nlibrary(survival)\nlibrary(tidyverse)\n\nIn the period 1962-77 a total of \\(205\\) patients with malignant melanoma (cancer of the skin) were operated at Odense University hospital in Denmark. A number of covariates were recorded at operation, and the patients were followed up until death or censoring at the end of the study at December 31, 1977. We will study death from malignant melanoma considering death from other causes as censorings. (Source: Andersen, Borgan, Gill & Keiding, Springer, 1993.)\nYou may read the data into R by the command:\n\nmelanoma = read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/melanoma.txt\",header=T) %&gt;% \n  as_tibble()\n\nThe data are organized with one line for each of the 205 patients, and with the following variables in the seven columns:\n\nstatus: status (1=death from disease, 2=censored, 4=death from other cause)\nlifetime: life time from operation in years\nulcer: ulceration (1=present, 2=absent)\nthickn: tumor thickness in mm\nsex: 1=female, 2=male\nage: age at operation in years\ngrthick: grouped tumor thickness [1: 0-1 mm (i.e. below 2 mm), 2: 2-4 mm (i.e. at least 2 mm, but below 5 mm) , 3: 5+ mm (i.e. 5 mm or more)]\n\nThe following commands provide a Nelson-Aalen plot for female melanoma patients. (The survival-library has to be loaded.)\n\nsurv.f = survival::survfit(Surv(lifetime,status==1) ~ 1, data = melanoma, \n  subset = (sex == 1), ctype = 1) # ctype = 1 means NA estimator\nsurv.m = survival::survfit(Surv(lifetime,status==1) ~ 1, data = melanoma, \n  subset = (sex == 2), ctype = 1)\n\nplot(surv.f, fun=\"cumhaz\", mark.time=FALSE, conf.type=\"plain\", xlim=c(0,10), ylim=c(0,0.80), main=\"Females\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\n\n\nplot(surv.m, fun=\"cumhaz\", mark.time=FALSE, conf.type=\"plain\", xlim=c(0,10), ylim=c(0,0.80), main=\"Males\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\n\n\n\n\nPerform the commands and interpret the Nelson-Aalen plot.\nMake a Nelson-Aalen plot for males and compare with the plot for females.\n\nTo plot the Nelson-Aalen estimates for both genders in the same figure, we may give the commands:\n\nsurv.sex = survival::survfit(Surv(lifetime,status==1) ~ strata(sex), data=melanoma, ctype=1)\n\nplot(surv.sex, fun=\"cumhaz\", mark.time=FALSE, lty=1:2, xlim=c(0,10), ylim=c(0,0.80), main=\"Gender\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"Females\",\"Males\"), lty=1:2)\n\n\n\n\n\nPerform the commands and inspect the plot.\n\n\nStraight slope =&gt; constant hazard independent of gender\n\n\nMake Nelson-Aalen plots for patients with ulceration present and absent and interpret the plots. (Ulceration is “present” if the surface of the tumor viewed in a microscope show signs of ulcers and “absent” otherwise.)\n\n\nsurv.ulcer = survival::survfit(Surv(lifetime,status==1) ~ strata(ulcer), data=melanoma, ctype=1)\n\nplot(surv.ulcer, fun=\"cumhaz\", mark.time=FALSE, lty=1:2, xlim=c(0,10), ylim=c(0,0.80), main=\"Ulceration\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"Present\",\"Absent\"), lty=1:2)\n\n\n\n\n\nMake Nelson-Aalen plots for the three thickness groups 0-1 mm, 2-4 mm, 5+ mm and interpret the plots.\n\n\nsurv.grthick = survival::survfit(Surv(lifetime,status==1) ~ strata(grthick), data=melanoma, ctype=1)\n\nplot(surv.grthick, fun=\"cumhaz\", mark.time=FALSE, lty=1:3, xlim=c(0,10), \n  ylim=c(0,0.80), main=\"Tumor thickness\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"0-1 mm\",\"2-4 mm\", \"5+ mm\"), lty=1:3)"
  },
  {
    "objectID": "na_km_logrank.html#kaplan-meier-and-log-rank-test",
    "href": "na_km_logrank.html#kaplan-meier-and-log-rank-test",
    "title": "Non-parametric estimators",
    "section": "Kaplan-Meier and log-rank test",
    "text": "Kaplan-Meier and log-rank test\nIn this exercise, we will use the Kaplan-Meier estimator and the log-rank test to study survival for the melanoma patients.\nWe will consider Kaplan-Meier estimates for the mortality from malignant melanoma treating death from other causes as censoring.\nWe may compute and plot the Kaplan-Meier estimate of the survival distribution for male patients by the commands (you need to load the survival-library)\n\nfit.m=survfit(Surv(lifetime,status==1)~1,data=melanoma, subset=(sex==2), conf.type=\"plain\")\nplot(fit.m, mark.time=FALSE, xlab=\"Years after operation\", main = \"Males\")\nabline(h = 0.75, col=\"red\")\nabline(h = 0.5, col=\"blue\")\n\n\n\n\nTo obtain a summary of the results, you may give the command:\n\n#?quantile.survfit\nsummary(fit.m)\n\nCall: survfit(formula = Surv(lifetime, status == 1) ~ 1, data = melanoma, \n    subset = (sex == 2), conf.type = \"plain\")\n\n  time n.risk n.event survival std.err lower 95% CI upper 95% CI\n 0.507     76       1    0.987  0.0131        0.961        1.000\n 0.559     75       1    0.974  0.0184        0.938        1.000\n 0.575     74       1    0.961  0.0223        0.917        1.000\n 0.636     73       1    0.947  0.0256        0.897        0.998\n 1.167     72       1    0.934  0.0284        0.878        0.990\n 1.449     70       1    0.921  0.0310        0.860        0.982\n 1.701     69       1    0.908  0.0333        0.842        0.973\n 1.723     68       1    0.894  0.0354        0.825        0.964\n 1.805     67       1    0.881  0.0373        0.808        0.954\n 1.967     66       1    0.867  0.0390        0.791        0.944\n 2.060     65       1    0.854  0.0407        0.774        0.934\n 2.134     64       1    0.841  0.0422        0.758        0.923\n 2.173     63       1    0.827  0.0435        0.742        0.913\n 2.649     62       1    0.814  0.0448        0.726        0.902\n 2.677     61       1    0.801  0.0461        0.710        0.891\n 2.852     60       1    0.787  0.0472        0.695        0.880\n 2.910     59       1    0.774  0.0482        0.680        0.869\n 2.945     58       1    0.761  0.0492        0.664        0.857\n 3.364     57       1    0.747  0.0501        0.649        0.846\n 3.932     55       1    0.734  0.0510        0.634        0.834\n 4.126     53       1    0.720  0.0519        0.618        0.822\n 4.153     51       1    0.706  0.0528        0.602        0.809\n 4.340     50       1    0.692  0.0536        0.587        0.797\n 4.630     47       1    0.677  0.0544        0.570        0.784\n 5.647     32       1    0.656  0.0567        0.545        0.767\n 5.762     29       1    0.633  0.0591        0.517        0.749\n 6.542     25       1    0.608  0.0619        0.487        0.729\n 7.027     22       1    0.580  0.0650        0.453        0.708\n 7.622     21       1    0.553  0.0675        0.420        0.685\n\n\n\nPerform these commands and interpret the Kaplan-Meier plot. Determine the lower quartile of the survival distribution for males with 95% confidence limits using the output from the summary-command. (Note that the lower quartile corresponds to 75% survival probability.)\n\n\nLook at the first time the Survival probability falls below \\(75\\%\\)\n\n\nWe may obtain the quartiles of the survival distribution for males by the command\n\n\nquantile(fit.m)\n\n$quantile\n      25       50       75 \n3.364384       NA       NA \n\n$lower\n      25       50       75 \n2.172603 6.542466       NA \n\n$upper\n      25       50       75 \n5.761644       NA       NA \n\n\nPerform this command and compare with the result you obtained in a).\n\nMake a Kaplan-Meier plot for females, and determine the lower quartile for females with 95% confidence limits (if possible). Compare with the results for males.\n\n\nfit.f=survfit(Surv(lifetime,status==1)~1,data=melanoma, subset=(sex==1), conf.type=\"plain\")\nplot(fit.f, mark.time=FALSE, xlab=\"Years after operation\", main = \"Females\")\n\n\n\nquantile(fit.f)\n\n$quantile\n      25       50       75 \n8.334247       NA       NA \n\n$lower\n     25      50      75 \n5.29589      NA      NA \n\n$upper\n25 50 75 \nNA NA NA \n\n\n\nUse the log-rank test to test the null hypothesis that males and females have the same mortality from malignant melanoma:\n\n\nsurvdiff(Surv(lifetime,status==1) ~ sex,data=melanoma)\n\nCall:\nsurvdiff(formula = Surv(lifetime, status == 1) ~ sex, data = melanoma)\n\n        N Observed Expected (O-E)^2/E (O-E)^2/V\nsex=1 126       28     37.1      2.25      6.47\nsex=2  79       29     19.9      4.21      6.47\n\n Chisq= 6.5  on 1 degrees of freedom, p= 0.01 \n\n\nWhat may you conclude from the test?\n\nMake Kaplan-Meier plots for patients with ulceration present and absent and interpret the results. Is it possible to estimate the lower quartile for both ulceration groups? Estimate the lower quartile with confidence limits if possible. Is there a significant difference in cancer mortality for patients with ulceration present and absent?\n\n\nplot(surv.ulcer, mark.time=FALSE, lty = 1:2, xlab=\"Years after operation\", main = \"Ulceration\")\nlegend(\"bottomleft\", c(\"Present\",\"Absent\"), lty=1:2)\n\n\n\n\n\nquantile(surv.ulcer)\n\n$quantile\n                            25       50 75\nstrata(ulcer)=ulcer=1 2.690411 8.334247 NA\nstrata(ulcer)=ulcer=2       NA       NA NA\n\n$lower\n                            25       50 75\nstrata(ulcer)=ulcer=1 2.060274 4.728767 NA\nstrata(ulcer)=ulcer=2 7.621918       NA NA\n\n$upper\n                            25 50 75\nstrata(ulcer)=ulcer=1 4.126027 NA NA\nstrata(ulcer)=ulcer=2       NA NA NA\n\n\n\n# NO STRATA IN THE FORMULA NEEDED!\nsurvdiff(formula = Surv(lifetime, status == 1) ~ ulcer, data = melanoma)\n\nCall:\nsurvdiff(formula = Surv(lifetime, status == 1) ~ ulcer, data = melanoma)\n\n          N Observed Expected (O-E)^2/E (O-E)^2/V\nulcer=1  90       41     21.2      18.5      29.6\nulcer=2 115       16     35.8      10.9      29.6\n\n Chisq= 29.6  on 1 degrees of freedom, p= 5e-08 \n\n\n\nMake Kaplan-Meier plots for the three thickness groups 0-1 mm, 2-4 mm, 5+ mm and interpret the plots. Estimate the lower quartile with confidence limits if possible. Is there a significant difference in cancer mortality between the three thickness groups?\n\n\nSame procedure as above!!!"
  },
  {
    "objectID": "cox_regr.html",
    "href": "cox_regr.html",
    "title": "Cox Regression (low-dim)",
    "section": "",
    "text": "library(survival)\nlibrary(tibble)\n\nFrom 1962 to 1969 a number of patients with liver cirrhosis at several hospitals in Copenhagen were included in a randomized clinical trial. The purpose of the study was to investigate whether patients treated with the hormone prednisone had a better survival than patients who got an inactive placebo treatment. In this exercise, we will restrict attention to the \\(386\\) patients in the study who had no excess fluid in the abdomen at entry. (Source: Andersen, Borgan, Gill & Keiding, Springer, 1993.)\nWe will study the effect of treatment with prednisone. We will also investigate the effect on survival of the covariates sex, age, and prothrombin index (a measurement based on a blood test of some coagulation factors produced by the liver, in percent of the normal value).\nYou may read the data into R by the command:\n\nliver = read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/liver.txt\", header=T) %&gt;% as_tibble()\nliver\n\n# A tibble: 386 × 6\n   status  time treat   sex   age  prot\n    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;\n 1      0    22     0     0    75    94\n 2      0    24     0     0    53    26\n 3      0    24     1     0    76    43\n 4      0    25     0     1    46   100\n 5      1    27     0     1    76    71\n 6      0    29     0     1    51    68\n 7      0    30     1     1    49    72\n 8      0    30     0     1    36    84\n 9      0    30     1     1    54    60\n10      1    33     1     0    60   100\n# ℹ 376 more rows\n\n\nThe data are organized with one line for each of the \\(386\\) patients, and with the following variables in the six columns:\n\nstatus: indicator for death/censoring (1=dead; 0=censored)\ntime: time in days from start of treatment to death/censoring\ntreat: treatment (0=prednisone; 1=placebo)\nsex: gender (0=female; 1=male)\nage: age in years at start of treatment\nprot: prothrombin index\n\nTo get an overview of the data, we will first do univariate analyses of the effects of the covariates treatment, sex, age and prothrombin index using Kaplan-Meier plots and the log-rank tests.\nFor treatment, you may give the commands (when time is converted to years).\n\nfit.treat = survfit(Surv(time/365.25, status) ~ factor(treat), data = liver)\n\nplot(fit.treat, mark.time=FALSE, xlab=\"Years after randomization\", lty=1:2, main=\"KM - Treatment\")\nlegend(\"bottomleft\",c(\"Prednisone\",\"Placebo\"),lty=1:2)\n\n\n\n\n\nsurvdiff(Surv(time/365.25,status) ~ factor(treat), data=liver)\n\nCall:\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(treat), \n    data = liver)\n\n                  N Observed Expected (O-E)^2/E (O-E)^2/V\nfactor(treat)=0 191       94      111      2.56      5.42\nfactor(treat)=1 195      117      100      2.83      5.42\n\n Chisq= 5.4  on 1 degrees of freedom, p= 0.02 \n\n\n\nPerform the commands and interpret the results.\nPerform similar analyses as in a) for the covariate sex.\n\n\nfit.sex = survfit(Surv(time/365.25, status) ~ factor(sex), data = liver)\n\nplot(fit.sex, mark.time=FALSE, xlab=\"Years after randomization\", lty=1:2, main=\"KM - Sex\")\nlegend(\"bottomleft\", c(\"Female\",\"Male\"), lty=1:2)\n\n\n\n\n\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(sex), data = liver)\n\nCall:\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(sex), data = liver)\n\n                N Observed Expected (O-E)^2/E (O-E)^2/V\nfactor(sex)=0 159       81     91.8     1.268      2.25\nfactor(sex)=1 227      130    119.2     0.977      2.25\n\n Chisq= 2.3  on 1 degrees of freedom, p= 0.1 \n\n\nWe want to do similar analyses as in a) and b) for the numeric covariates age and prothrombin index. But then we first have to make a grouping based on these covariates. In order to group age into the groups: 49 years or less, 50-59 years, 60-69 years, and 70 years or more, you may create a new categorial covariate agegroup by the command:\n\nliver$agegroup=cut(liver$age, breaks=c(0,49,59,69,100),labels=1:4)\nunique(liver$agegroup)\n\n[1] 4 2 1 3\nLevels: 1 2 3 4\n\n\n\nMake a grouping of age by the command given above, and perform similar analyses for age group as the ones in a) and b).\n\n\nfit.ageg = survfit(Surv(time/365.25, status) ~ factor(agegroup), data = liver)\n\nplot(fit.ageg, mark.time=FALSE, xlab=\"Years after randomization\", lty=1:4, main=\"KM - Age group\", col = 1:4)\nlegend(\"bottomleft\", c(\"0-49\",\"50-59\", \"60-69\", \"70-100\"), lty=1:4, col = 1:4)\n\n\n\n\n\n# factor() doesn't play a role here =&gt; in Cox regression it does!\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(agegroup), data = liver)\n\nCall:\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(agegroup), \n    data = liver)\n\n                     N Observed Expected (O-E)^2/E (O-E)^2/V\nfactor(agegroup)=1  74       23     46.4     11.78     15.16\nfactor(agegroup)=2 116       59     69.4      1.55      2.33\nfactor(agegroup)=3 146       97     73.2      7.78     12.05\nfactor(agegroup)=4  50       32     22.1      4.44      4.98\n\n Chisq= 25.8  on 3 degrees of freedom, p= 1e-05 \n\n\n\nMake an appropriate grouping of prothrombin index and do similar analyses for grouped prothrombin as in a), b) and c).\n\n\nquantile(liver$prot)\n\n  0%  25%  50%  75% 100% \n  26   58   72   90  135 \n\nsummary(liver$prot)\n\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  26.00   58.00   72.00   73.55   90.00  135.00 \n\nliver$protgroup = cut(liver$prot, breaks=c(0,58,90,135),labels=1:3)\nunique(liver$protgroup)\n\n[1] 3 1 2\nLevels: 1 2 3\n\n\n\nfit.protg = survfit(Surv(time/365.25, status) ~ factor(protgroup), data = liver)\n\nplot(fit.protg, mark.time=FALSE, xlab=\"Years after randomization\", lty=1:3, main=\"KM - Protgroup\", col = 1:3)\nlegend(\"bottomleft\", c(\"0-58\",\"59-90\", \"91-135\"), lty=1:3, col = 1:3)\n\n\n\n\n\nHigher prot-index is better!!!\n\n\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(protgroup), data = liver)\n\nCall:\nsurvdiff(formula = Surv(time/365.25, status) ~ factor(protgroup), \n    data = liver)\n\n                      N Observed Expected (O-E)^2/E (O-E)^2/V\nfactor(protgroup)=1 104       71     52.8     6.285     8.407\nfactor(protgroup)=2 190       99    102.8     0.137     0.268\nfactor(protgroup)=3  92       41     55.5     3.769     5.127\n\n Chisq= 10.2  on 2 degrees of freedom, p= 0.006 \n\n\nIn order to study jointly the effects the covariates, we fit a Cox regression model with all covariates. If we use age and prothrombin as numeric covariates, we may give the commands:\n\ncox.fit = coxph(Surv(time/365.25, status) ~ factor(treat) + factor(sex) + age + prot, data = liver)\n\nsummary(cox.fit)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    age + prot, data = liver)\n\n  n= 386, number of events= 211 \n\n                    coef exp(coef)  se(coef)      z Pr(&gt;|z|)    \nfactor(treat)1  0.292844  1.340233  0.139504  2.099  0.03580 *  \nfactor(sex)1    0.382945  1.466597  0.145403  2.634  0.00845 ** \nage             0.046925  1.048043  0.008038  5.838 5.28e-09 ***\nprot           -0.010607  0.989449  0.003351 -3.165  0.00155 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n               exp(coef) exp(-coef) lower .95 upper .95\nfactor(treat)1    1.3402     0.7461     1.020     1.762\nfactor(sex)1      1.4666     0.6819     1.103     1.950\nage               1.0480     0.9542     1.032     1.065\nprot              0.9894     1.0107     0.983     0.996\n\nConcordance= 0.65  (se = 0.021 )\nLikelihood ratio test= 53.44  on 4 df,   p=7e-11\nWald test            = 50.36  on 4 df,   p=3e-10\nScore (logrank) test = 50.44  on 4 df,   p=3e-10\n\n\n\nTreat = 1 (placebo) or sex = 1 (male) or higher age is worse (HR = exp(coef) &gt; 1) given that all the other covariates remain the same\nAlso smaller prot is worse (but not too much, also the same for age)\n\n\nPerform the commands, and interpret the estimated hazard ratios.\nDo you think that it is reasonable to use both age and prothrombin index as numeric covariates in the Cox regression model? If not, also fit model(s) where you use the grouped version of one or both of these covariates. Interpret the estimated hazard ratios.\n\n\ncox.fit2 = coxph(Surv(time/365.25, status) ~ factor(treat) + factor(sex) + agegroup + protgroup, data = liver)\nsummary(cox.fit2)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    agegroup + protgroup, data = liver)\n\n  n= 386, number of events= 211 \n\n                  coef exp(coef) se(coef)      z Pr(&gt;|z|)    \nfactor(treat)1  0.3267    1.3863   0.1406  2.324 0.020151 *  \nfactor(sex)1    0.3211    1.3787   0.1443  2.225 0.026057 *  \nagegroup2       0.4852    1.6245   0.2468  1.966 0.049307 *  \nagegroup3       1.0176    2.7665   0.2333  4.362 1.29e-05 ***\nagegroup4       1.0624    2.8933   0.2758  3.852 0.000117 ***\nprotgroup2     -0.3518    0.7034   0.1583 -2.223 0.026249 *  \nprotgroup3     -0.5966    0.5507   0.1972 -3.025 0.002489 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n               exp(coef) exp(-coef) lower .95 upper .95\nfactor(treat)1    1.3863     0.7213    1.0524    1.8261\nfactor(sex)1      1.3787     0.7253    1.0390    1.8294\nagegroup2         1.6245     0.6156    1.0015    2.6351\nagegroup3         2.7665     0.3615    1.7514    4.3701\nagegroup4         2.8933     0.3456    1.6851    4.9679\nprotgroup2        0.7034     1.4216    0.5158    0.9593\nprotgroup3        0.5507     1.8160    0.3741    0.8106\n\nConcordance= 0.645  (se = 0.02 )\nLikelihood ratio test= 46.95  on 7 df,   p=6e-08\nWald test            = 43.47  on 7 df,   p=3e-07\nScore (logrank) test = 44.97  on 7 df,   p=1e-07\n\n\nThis exercise is a continuation of the exercise on Cox regression for the liver cirrhosis data from yesterday. The liver cirrhosis data are described in the exercise from yesterday. There it is also explained how you may read the data into R.\nWe first fit a Cox regression model with all four covariates by the commands:\n\ncox.fit=coxph(Surv(time/365.25,status)~factor(treat)+factor(sex)+age+prot,data=liver)\nsummary(cox.fit)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    age + prot, data = liver)\n\n  n= 386, number of events= 211 \n\n                    coef exp(coef)  se(coef)      z Pr(&gt;|z|)    \nfactor(treat)1  0.292844  1.340233  0.139504  2.099  0.03580 *  \nfactor(sex)1    0.382945  1.466597  0.145403  2.634  0.00845 ** \nage             0.046925  1.048043  0.008038  5.838 5.28e-09 ***\nprot           -0.010607  0.989449  0.003351 -3.165  0.00155 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n               exp(coef) exp(-coef) lower .95 upper .95\nfactor(treat)1    1.3402     0.7461     1.020     1.762\nfactor(sex)1      1.4666     0.6819     1.103     1.950\nage               1.0480     0.9542     1.032     1.065\nprot              0.9894     1.0107     0.983     0.996\n\nConcordance= 0.65  (se = 0.021 )\nLikelihood ratio test= 53.44  on 4 df,   p=7e-11\nWald test            = 50.36  on 4 df,   p=3e-10\nScore (logrank) test = 50.44  on 4 df,   p=3e-10\n\n\n\nDiscuss the assumptions of the model fitted above.\n\nCHECK CONTINUOUS VARIABLES LOG-LINEARITY ASSUMPTION:\n\nInvestigate if there is a log-linear effect of age, we may give the commands:\n\n\ncox.spage=coxph(Surv(time/365.25,status)~factor(treat)+factor(sex)+pspline(age)+prot,data=liver)\nprint(cox.spage)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    pspline(age) + prot, data = liver)\n\n                         coef se(coef)      se2    Chisq   DF       p\nfactor(treat)1        0.29335  0.14085  0.14049  4.33754 1.00  0.0373\nfactor(sex)1          0.37413  0.14599  0.14595  6.56715 1.00  0.0104\npspline(age), linear  0.04689  0.00820  0.00820 32.71358 1.00 1.1e-08\npspline(age), nonlin                             1.66153 3.09  0.6609\nprot                 -0.01081  0.00337  0.00337 10.26994 1.00  0.0014\n\nIterations: 4 outer, 12 Newton-Raphson\n     Theta= 0.802 \nDegrees of freedom for terms= 1.0 1.0 4.1 1.0 \nLikelihood ratio test=56.1  on 7.08 df, p=1e-09\nn= 386, number of events= 211 \n\ntermplot(cox.spage,se=T,terms=3)\n\n\n\n\nDiscuss if it is reasonable to assume a log-linear effect of age? =&gt; No =&gt; plot is linear\n\nInvestigate if there is a log-linear effect of prothrombin index.\n\n\ncox.spprot=coxph(Surv(time/365.25,status)~factor(treat)+factor(sex)+age+pspline(prot),data=liver)\nprint(cox.spprot)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    age + pspline(prot), data = liver)\n\n                          coef se(coef)      se2    Chisq   DF       p\nfactor(treat)1         0.31796  0.14161  0.14126  5.04114 1.00  0.0248\nfactor(sex)1           0.41439  0.14879  0.14846  7.75624 1.00  0.0054\nage                    0.04749  0.00811  0.00808 34.33445 1.00 4.6e-09\npspline(prot), linear -0.01031  0.00317  0.00317 10.60438 1.00  0.0011\npspline(prot), nonlin                             3.66752 3.05  0.3077\n\nIterations: 5 outer, 14 Newton-Raphson\n     Theta= 0.855 \nDegrees of freedom for terms= 1.0 1.0 1.0 4.1 \nLikelihood ratio test=57.7  on 7.04 df, p=5e-10\nn= 386, number of events= 211 \n\ntermplot(cox.spprot,se=T,terms=4)\n\n\n\n\nThe result above gives some indication (but not very clear!) that the effect of prothrombin index is not log-linear. In the remainder of this exercise, we will work with prothrombin grouped in the three groups: (i) prothrombin index 49 or below, (ii) prothrombin index 50-89, and (iii) prothrombin index 90 or above. We may create a new categorial covariate protgroup by the command:\n\nliver$protgroup=cut(liver$prot, breaks=c(0,49,89,150),labels=1:3)\n\nWe may fit a Cox model with this variable (together with the other three covariates) by the commands\n\ncox.grfit=coxph(Surv(time/365.25,status)~factor(treat)+factor(sex)+age+factor(protgroup),data=liver)\nsummary(cox.grfit)\n\nCall:\ncoxph(formula = Surv(time/365.25, status) ~ factor(treat) + factor(sex) + \n    age + factor(protgroup), data = liver)\n\n  n= 386, number of events= 211 \n\n                        coef exp(coef)  se(coef)      z Pr(&gt;|z|)    \nfactor(treat)1      0.289942  1.336351  0.139747  2.075 0.038008 *  \nfactor(sex)1        0.413701  1.512405  0.147978  2.796 0.005179 ** \nage                 0.047641  1.048794  0.008003  5.953 2.63e-09 ***\nfactor(protgroup)2 -0.578836  0.560550  0.182306 -3.175 0.001498 ** \nfactor(protgroup)3 -0.781223  0.457846  0.211930 -3.686 0.000228 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n                   exp(coef) exp(-coef) lower .95 upper .95\nfactor(treat)1        1.3364     0.7483    1.0162    1.7574\nfactor(sex)1          1.5124     0.6612    1.1316    2.0213\nage                   1.0488     0.9535    1.0325    1.0654\nfactor(protgroup)2    0.5606     1.7840    0.3921    0.8013\nfactor(protgroup)3    0.4578     2.1841    0.3022    0.6936\n\nConcordance= 0.654  (se = 0.021 )\nLikelihood ratio test= 56.69  on 5 df,   p=6e-11\nWald test            = 55.11  on 5 df,   p=1e-10\nScore (logrank) test = 55.75  on 5 df,   p=9e-11\n\n\nCheck if the assumption of proportional hazards seems to be fulfilled for the model: a non-significant p-value means PH is okay/satisfied, since \\(H_0 = (slope = 0)\\), i.e. PH means that the time-dependent plot should approximately be a straight line:\n\nphres = cox.zph(cox.grfit, terms = FALSE)\nphres\n\n                   chisq df    p\nfactor(treat)1     0.892  1 0.34\nfactor(sex)1       1.653  1 0.20\nage                0.264  1 0.61\nfactor(protgroup)2 1.372  1 0.24\nfactor(protgroup)3 0.228  1 0.63\nGLOBAL             3.836  5 0.57\n\nplot(phres)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCheck this dependence with time: \\(b_1\\) \\(b_1+b_{12}\\times log(t)\\)\n\nphres = cox.zph(cox.grfit, transform = 'log', terms = FALSE)\nphres\n\n                   chisq df    p\nfactor(treat)1     0.240  1 0.62\nfactor(sex)1       1.006  1 0.32\nage                0.593  1 0.44\nfactor(protgroup)2 1.406  1 0.24\nfactor(protgroup)3 0.660  1 0.42\nGLOBAL             2.738  5 0.74\n\nplot(phres)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPredicting survival curves for new patients:\n\nA prednisone treated woman aged 60 years who has prothrombin index 90 or above\nA prednisone treated woman aged 60 years who has prothrombin index 49 or below\nA placebo treated man aged 60 years who has prothrombin index 90 or above\nA placebo treated man aged 60 years who has prothrombin index 49 or below\n\n\nnewdata = data.frame(\n  sex = c(0,0,1,1), \n  treat = c(0,0,1,1), \n  age = rep(60, 4),\n  protgroup = c(3,1,3,1))\nnewdata\n\n  sex treat age protgroup\n1   0     0  60         3\n2   0     0  60         1\n3   1     1  60         3\n4   1     1  60         1\n\n\n\nsurv.res = survfit(cox.grfit, newdata = newdata)\nplot(surv.res, fun=\"cumhaz\", mark.time=FALSE, xlim=c(0,10),\nxlab=\"Years since operation\", ylab=\"Cumulative hazard\", lty=1:4, lwd=2, col = 1:4)\nlegend(\"topleft\",c(\"female, treated, 60y, progr = 3\",\"female, treated, 60y, protgr = 1\",\n\"male, placebo, 60y, progr = 3\",\"female, placebo, 60y, protgr = 1\"), lty=1:4,lwd=2, col = 1:4)\n\n\n\n\n\nplot(surv.res, fun=\"surv\", mark.time=FALSE, xlim=c(0,10),\nxlab=\"Years since operation\", ylab=\"Survival Probability\", lty=1:4, lwd=2, col = 1:4)\nlegend(\"topleft\",c(\"female, treated, 60y, progr = 3\",\"female, treated, 60y, protgr = 1\",\n\"male, placebo, 60y, progr = 3\",\"female, placebo, 60y, protgr = 1\"), lty=1:4,lwd=2, col = 1:4)"
  },
  {
    "objectID": "cox_regr_high_dim.html",
    "href": "cox_regr_high_dim.html",
    "title": "Cox regression (high-dim)",
    "section": "",
    "text": "library(survival)\nlibrary(glmnet)\n\nLoading required package: Matrix\n\n\nLoaded glmnet 4.1-8\n\nlibrary(tibble)\nlibrary(dplyr)\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\n\nIn this exercise, we will use data for \\(115\\) Norwegian women with breast cancer. For each of the women, we have gene expression measurements for \\(549\\) «intrinsic genes» and information on the time to breast cancer death or censoring. (Source: Sørlie et al. Proc. Natl Acad. Sci. USA, 2003.)\nWe will use penalized Cox regression to investigate if the gene expressions have predictive power for survival and try to identify which genes are of importance.\nYou may read the data into R by the command:\n\nbrcancer=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/norw-breast-cancer.txt\")\n\nBefore we analyse the data, we will define 10 folds that may be used in the cross-validation (to ensure – for pedagogical reasons - that all students get the same results). We do this by the commands\n\nset.seed(33575)\nind=sample(1:115,115)\nbrcancer=brcancer[ind,]\nfold=rep(1:10,length.out=115)\n\nWe extract the (censored) survival times, the censoring/death statuses and the gene expressions by the commands\n\ntime=brcancer[,1]\nstatus=brcancer[,2]\ngeneexpr=as.matrix(brcancer[,-(1:2)])\n\nCensoring problems with the folds?\n\nsum(status == 0)/length(status)\n\n[1] 0.6695652\n\nstatus[fold == 5]\n\n [1] 0 0 0 0 0 1 0 0 0 0 0 0\n\n\nWe may then do a Cox-lasso regression with 10-fold cross-validation and plot the cross-validation curve by the commands (you need to load the survival and glmnet-packages)\n\ncox.lasso=cv.glmnet(geneexpr,Surv(time,status),family=\"cox\",foldid=fold, standardize=FALSE)\nplot(cox.lasso)\n\n\n\n\n\ncox.lasso$lambda.min\n\n[1] 0.2902299\n\nlog(cox.lasso$lambda.min)\n\n[1] -1.237082\n\nmin(cox.lasso$cvm)\n\n[1] 8.45301\n\n\n\nPerform the commands and interpret the cross-validation plot.\n\nWe may use the following commands to obtain a list of the genes that obtain an estimate that differ from zero (i.e. the selected genes):\n\ncoefficients=coef(cox.lasso, s=cox.lasso$lambda.min)\nactive.index=which(coefficients != 0)\nactive.coefficients=coefficients[active.index]\ncovarno=predict(cox.lasso, s=cox.lasso$lambda.min,type=\"nonzero\")\ncbind(covarno,active.coefficients)\n\n  which active.coefficients\n1   356          -0.1720938\n\n\nRepeat a number of times and see how the number of genes and the list of selected genes vary from splits to splits:\n\nn = 25\ndl = list()\nfor(i in 1:n) {\n  # message(i)\n  cox.lasso = cv.glmnet(geneexpr,Surv(time,status),family=\"cox\",nfolds=10, standardize=FALSE)\n  coef_tbl = coef(cox.lasso, s = 'lambda.min') %&gt;% # s = 'lambda.' different\n    as.matrix() %&gt;%\n    as.data.frame() %&gt;%\n    tibble::rownames_to_column(var = 'coef_name') %&gt;%\n    dplyr::rename(value = `1`) %&gt;%\n    filter(value != 0)\n  dl[[i]] = coef_tbl\n}\n\nres = dplyr::bind_rows(dl)\n\n\nres %&gt;% \n  group_by(coef_name) %&gt;% \n  summarise(mean_coef = mean(value), ntimes=n()) %&gt;%\n  arrange(desc(ntimes))\n\n# A tibble: 5 × 3\n  coef_name mean_coef ntimes\n  &lt;chr&gt;         &lt;dbl&gt;  &lt;int&gt;\n1 V358       -0.174       25\n2 V23        -0.0384      18\n3 V200       -0.0193       6\n4 V271       -0.00971      3\n5 V233        0.00290      1\n\n\nFinally, if time allows, you may try out the elastic net. You may fit a Cox elastic net (with alpha=0.5) for the original split into 10 folds by the command:\n\ncox.net=cv.glmnet(geneexpr,Surv(time,status),family=\"cox\",alpha=0.5,foldid=fold, standardize=FALSE)\nplot(cox.net)\n\n\n\n\n\nPerform the command and see how many and which genes are selected."
  },
  {
    "objectID": "aalen.html",
    "href": "aalen.html",
    "title": "Additive regression",
    "section": "",
    "text": "library(survival)\nlibrary(tibble)\nlibrary(dplyr)\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\n\nAt the university hospital of the University of Massachusetts one has for a number of years studied the survival of patients admitted with an acute myocardial infarction (AMI- aka HEART ATTACK!). One aim of the study has been to investigate whether the survival of AMI patients has improved over time. A number of covariates were measured at hospitalization. In addition to information on time of hospitalization (here given in five years periods), we will in this problem restrict attention to the two demographic covariates age and sex, one covariate that is related to the seriousness of the AMI (amount of “heart enzyme”), and one covariate that gives information on whether the patient has had an AMI earlier or not. Further we will restrict attention to the first three years after AMI, so patients who live longer than \\(1095 = 3 \\times 365\\) days have been censored at that time.\nYou may read the AMI-data into R by the command:\n\nami=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/ami.txt\",header=T) %&gt;% as_tibble()\nami\n\n# A tibble: 481 × 8\n      id  days status   per   age   sex enzym  prev\n   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;\n 1     1     1      1     1    62     1   485     0\n 2     2     1      1     1    78     1   910     1\n 3     3     1      1     1    81     1   320     0\n 4     4     1      1     1    79     1  3290     1\n 5     5     2      1     1    60     1  2500     1\n 6     6     2      1     1    72     0    99     0\n 7     7     2      1     1    60     1  1200     0\n 8     8     3      1     1    83     1   160     0\n 9     9     3      1     1    78     0    66     1\n10    10  1095      0     1    72     1    99     0\n# ℹ 471 more rows\n\n\nThe data are organized with one line for each of the \\(481\\) patients, and with the following variables in the seven columns:\n\nid: Patient number\ndays: Number of days from hospitalization to death or censoring\nstatus: Indicator for death (1) or censoring (0)\nper: Five year period (1 = 1975-79, 2 = 1980-84, 3 = 1985-89)\nage: Age at hospitalization (in years)\nsex: Sex (0 = male, 1 = female)\nenzym: Amount of “heart enzyme” measured as ”international units” divided by 100\nprev: Information on earlier AMIs (0 = no earlier AMI, 1 = at least one earlier AMI).\n\nWe will study the effect of the five covariates (per, age, sex, enzym and prev) using the additive regression model. Our main interest lies in a simultaneous analysis of all five covariates. But nevertheless we will start out by fitting additive regression models with one covariate at a time.\n\nFirst we fit an additive model with sex as the only covariate and plot the estimated cumulative regression function. This is achieved by the commands:\n\n\nfit.sex = survival::aareg(Surv(days,status) ~ factor(sex), data=ami)\nfit.sex\n\nCall:\nsurvival::aareg(formula = Surv(days, status) ~ factor(sex), data = ami)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n                slope    coef se(coef)    z        p\nIntercept    0.000734 0.00219 0.000222 9.85 6.93e-23\nfactor(sex)1 0.000405 0.00102 0.000407 2.51 1.20e-02\n\nChisq=6.31 on 1 df, p=0.012; test weights=aalen\n\nprint(fit.sex, maxtime = 100)\n\nCall:\nsurvival::aareg(formula = Surv(days, status) ~ factor(sex), data = ami)\n\n  n= 481 \n    44 out of 115 unique event times used\n\n               slope    coef se(coef)    z        p\nIntercept    0.00380 0.00186 0.000251 7.42 1.21e-13\nfactor(sex)1 0.00285 0.00124 0.000478 2.60 9.27e-03\n\nChisq=6.77 on 1 df, p=0.00927; test weights=aalen\n\n\nAlso test the null hypothesis that there is no effect of sex (marginally, i.e. when not corrected for the other covariates). You obtain the standardized test and its p-value from the last two columns of the output from the command print(fit.sex). (The maxtime option also works for the print command.)\n\nres = summary(fit.sex) # , maxtime = 100\nres$table[2,'p'] # borderline\n\n[1] 0.01200272\n\n\nIntercept figure always shows the baseline hazard (reference category when modeling with one covariate or all reference values when modeling with more covariates):\n\npar(mfrow=c(1,2))\nplot(fit.sex)\n\n\n\n\nYou may want to focus on the first 100 days after hospitalizations.\n\npar(mfrow=c(1,2))\nplot(fit.sex, maxtime = 100)\n\n\n\n\nEffect of sex variable is stronger the first 100 days (p-value):\n\nres = summary(fit.sex, maxtime = 100)\nres$table[2,'p']\n\n[1] 0.009270794\n\n\n\nFit an additive regression model for each of the other four covariates per, age, enzym and prev (one at a time). For each of the covariates you should interpret the estimates you obtain for the cumulative baseline and the cumulative regression function and decide whether the covariate has a significant effect (when not corrected for the effects of the other covariates). In order to ease interpretation of the estimated cumulative baseline function, you should center the numeric covariates age and enzym by subtracting their means.\n\nScale continuous variables:\n\nNote that the centering value (e.g. mean or other) is like the reference value:\n\n\nami2 = ami %&gt;% \n  mutate(age = (age - mean(age))/sd(age), enzym = (enzym - mean(enzym))/sd(enzym))\n\n\nper (hospitalization period) has no effect:\n\n\nfit.per = aareg(formula = Surv(days, status) ~ factor(per), data = ami)\nfit.per\n\nCall:\naareg(formula = Surv(days, status) ~ factor(per), data = ami)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n                 slope      coef se(coef)      z        p\nIntercept     8.66e-04  0.002540 0.000328  7.750 9.49e-15\nfactor(per)2  1.52e-05  0.000196 0.000458  0.428 6.69e-01\nfactor(per)3 -6.25e-05 -0.000104 0.000471 -0.222 8.25e-01\n\nChisq=0.43 on 2 df, p=0.805; test weights=aalen\n\npar(mfrow = c(1,3))\nplot(fit.per)\n\n\n\n\n\nfit.age = aareg(formula = Surv(days, status) ~ age, data = ami)\nfit.age\n\nCall:\naareg(formula = Surv(days, status) ~ age, data = ami)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n              slope      coef se(coef)     z        p\nIntercept -1.74e-03 -0.005130 1.00e-03 -5.13 2.90e-07\nage        4.22e-05  0.000116 1.64e-05  7.10 1.27e-12\n\nChisq=50.38 on 1 df, p=1.27e-12; test weights=aalen\n\npar(mfrow = c(1,2))\nplot(fit.age)\n\n\n\n\n\nScaling/Centering continuous variable age is important for the interpretation of the baseline hazard!!!\nHazard increases with larger age! (there is an effect)\n\n\nfit.age2 = aareg(formula = Surv(days, status) ~ age, data = ami2)\nfit.age2\n\nCall:\naareg(formula = Surv(days, status) ~ age, data = ami2)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n             slope    coef se(coef)    z        p\nIntercept 0.001010 0.00275 0.000204 13.4 3.46e-41\nage       0.000535 0.00147 0.000208  7.1 1.27e-12\n\nChisq=50.38 on 1 df, p=1.27e-12; test weights=aalen\n\npar(mfrow = c(1,2))\nplot(fit.age2)\n\n\n\n\n\nenzym has no significant effect:\n\n\nfit.enzym = aareg(formula = Surv(days, status) ~ enzym, data = ami2)\nfit.enzym\n\nCall:\naareg(formula = Surv(days, status) ~ enzym, data = ami2)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n             slope     coef se(coef)     z        p\nIntercept 0.000909 0.002580 0.000190 13.50 1.10e-41\nenzym     0.000223 0.000444 0.000269  1.65 9.92e-02\n\nChisq=2.72 on 1 df, p=0.0992; test weights=aalen\n\npar(mfrow = c(1,2))\nplot(fit.enzym)\n\n\n\n\n\nprev =&gt; previous hospitalization has significant effect:\n\n\nfit.prev = aareg(formula = Surv(days, status) ~ factor(prev), data = ami)\nfit.prev\n\nCall:\naareg(formula = Surv(days, status) ~ factor(prev), data = ami)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n                 slope    coef se(coef)    z        p\nIntercept     0.000654 0.00203 0.000207 9.85 6.93e-23\nfactor(prev)1 0.000674 0.00166 0.000444 3.75 1.77e-04\n\nChisq=14.06 on 1 df, p=0.000177; test weights=aalen\n\npar(mfrow = c(1,2))\nplot(fit.prev)\n\n\n\n\n\nFit an additive regression model with all the five covariates. Determine which of covariates have a significant effect on the mortality (using “backwards elimination”), and thereby obtain a “final model” where all covariates have a significant effect. Interpret the estimates of the cumulative baseline and the cumulative regression functions for your “final model”.\n\n\nfit.all = aareg(formula = Surv(days, status) ~ factor(per) + age + factor(sex) + enzym + factor(prev), data = ami2)\nfit.all\n\nCall:\naareg(formula = Surv(days, status) ~ factor(per) + age + factor(sex) + \n    enzym + factor(prev), data = ami2)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n                  slope      coef se(coef)      z        p\nIntercept      0.000842  0.002390 0.000425  5.630 1.83e-08\nfactor(per)2  -0.000140 -0.000176 0.000477 -0.368 7.13e-01\nfactor(per)3  -0.000297 -0.000681 0.000474 -1.440 1.50e-01\nage            0.000552  0.001480 0.000222  6.680 2.44e-11\nfactor(sex)1   0.000208  0.000389 0.000426  0.914 3.61e-01\nenzym          0.000387  0.000873 0.000283  3.090 2.01e-03\nfactor(prev)1  0.000647  0.001560 0.000454  3.430 5.98e-04\n\nChisq=67.78 on 6 df, p=1.16e-12; test weights=aalen\n\npar(mfrow = c(2,4))\nplot(fit.all)\n\n\n\n\n\nprint(fit.all, maxtime = 100)\n\nCall:\naareg(formula = Surv(days, status) ~ factor(per) + age + factor(sex) + \n    enzym + factor(prev), data = ami2)\n\n  n= 481 \n    44 out of 115 unique event times used\n\n                 slope      coef se(coef)     z        p\nIntercept      0.00519  0.002180 0.000481  4.53 5.91e-06\nfactor(per)2  -0.00273 -0.000834 0.000552 -1.51 1.31e-01\nfactor(per)3  -0.00206 -0.000728 0.000568 -1.28 1.99e-01\nage            0.00293  0.001260 0.000254  4.98 6.50e-07\nfactor(sex)1   0.00217  0.000874 0.000497  1.76 7.87e-02\nenzym          0.00388  0.001350 0.000395  3.42 6.27e-04\nfactor(prev)1  0.00277  0.001390 0.000514  2.71 6.77e-03\n\nChisq=46.16 on 6 df, p=2.75e-08; test weights=aalen\n\npar(mfrow = c(2,4))\nplot(fit.all, maxtime = 100)\n\n\n\n\nLet’s keep only the variables in the model that had a significant effect:\n\nfit.final = aareg(formula = Surv(days, status) ~ age + enzym + factor(prev), data = ami2)\nfit.final\n\nCall:\naareg(formula = Surv(days, status) ~ age + enzym + factor(prev), \n    data = ami2)\n\n  n= 481 \n    115 out of 115 unique event times used\n\n                 slope     coef se(coef)     z        p\nIntercept     0.000752 0.002270 0.000224 10.10 3.81e-24\nage           0.000554 0.001510 0.000212  7.10 1.23e-12\nenzym         0.000358 0.000812 0.000279  2.90 3.67e-03\nfactor(prev)1 0.000653 0.001570 0.000450  3.49 4.85e-04\n\nChisq=62.99 on 3 df, p=1.35e-13; test weights=aalen\n\npar(mfrow = c(2,2))\nplot(fit.final)\n\n\n\n\n\nWhen analyzing censored survival data, Cox regression is commonly used. Discuss benefits and drawbacks of using the additive model (rather than Cox’s model) for analyzing the AMI data.\n\n\nWith additive regression you can check what is the treatment effect across time, which you lose when doing CoxPH!"
  },
  {
    "objectID": "mstate.html",
    "href": "mstate.html",
    "title": "Multi-state models",
    "section": "",
    "text": "library(survival)\nlibrary(mstate)\nlibrary(tibble)\nlibrary(dplyr)\n\nIn this exercise, we will see how we may find the Nelson-Aalen estimates for the cumulative transition intensities and the Aalen-Johansen estimates for the transition probabilities in a Markov illness-death model. To this end, we will use the bone marrow transplantation data described in example 1.13 in the ABG-book and used for illustration in example 3.16. To read the data into R you may give the command:\n\nbonemarrow = read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/bone-marrow.txt\",header=T) %&gt;% as_tibble()\nbonemarrow %&gt;% select(T2, DF, TP, P)\n\n# A tibble: 137 × 4\n      T2    DF    TP     P\n   &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt;\n 1  2081     0    13     1\n 2  1602     0    18     1\n 3  1496     0    12     1\n 4  1462     0    13     1\n 5  1433     0    12     1\n 6  1377     0    12     1\n 7  1330     0    17     1\n 8   996     0    12     1\n 9   226     0    10     1\n10  1199     0    29     1\n# ℹ 127 more rows\n\n\nBone marrow transplantation data:\n\ng =&gt; Disease Group (1: ALL, 2: AML Low Risk, 3: AML High Risk)\nT1 =&gt; Time To Death Or On Study Time\nT2 =&gt; Disease Free Survival Time (Time To Relapse, Death Or End Of Study)\nD =&gt; Death Indicator (1: Dead, 0: Alive)\nR =&gt; Relapse Indicator (1: Relapsed, 0: Disease Free)\nDF =&gt; Disease Free Survival Indicator (1: Dead Or Relapsed, 0: Alive Disease Free)\nTA =&gt; Time To Acute Graft-Versus-Host Disease\nA =&gt; Acute GVHD Indicator (1: Developed Acute GVHD, 0: Never Developed Acute GVHD)\nTC =&gt; Time To Chronic Graft-Versus-Host Disease\nC =&gt; Chronic GVHD Indicator (1-Developed Chronic GVHD, 0:Never Developed Chronic GVHD)\nTP =&gt; Time To Return of Platelets to Normal Levels\nP =&gt; Platelet Recovery Indicator (1: Platelets Returned To Normal, 0-Platelets Never Returned to Normal)\nZ1 =&gt; Patient Age In Years\nZ2 =&gt; Donor Age In Years\nZ3 =&gt; Patient Sex (1-Male, 0-Female)\nZ4 =&gt; Donor Sex (1: Male, 0: Female)\nZ5 =&gt; Patient CMV Status (1: CMV Positive, 0: CMV Negative)\nZ6 =&gt; Donor CMV Status (1: CMV Positive, 0: CMV Negative)\nZ7 =&gt; Waiting Time to Transplant In Days\nZ8 =&gt; FAB (1: FAB Grade 4 Or 5 and AML, 0: Otherwise)\nZ9 =&gt; Hospital (1:The Ohio State University, 2: Alferd , 3: St. Vincent, 4: Hahnemann)\nZ10 =&gt; MTX Used as a Graft-Versus-Host- Prophylactic (1:Yes, 0:No)\n\nThe data contain information for \\(137\\) patients with acute leukemia who had a bone marrow transplantation. The patients were followed for a maximum of seven years, and times to relapse and death were recorded. It was also recorded if and when the platelet count of a patient returned to a self-sustaining level. The possible events for a patient may be described by an illness-death model without recovery with the three states “transplanted”, “platelet recovered”, and “relapsed or dead”. A patient starts out in state “transplanted” at time zero when he/she gets the bone marrow transplant. If the platelets recover, the patient moves to state “platelet recovered”, and if he/she then relapses or dies, the patient moves on to state “relapsed or dead”. If the patient relapses or dies without the platelets returning to a normal level, he moves directly from state “transplanted” to state “relapsed or dead”.\nTo find the Nelson-Aalen estimates and the empirical transition probabilities (i.e. Aalen-Johansen estimates) we will use the mstate package so this has to be installed and loaded.\nWe start out by defining the states and the possible transitions between them. This is achieved by the command:\n\ntmat = transMat(x = list(c(2,3),c(3),c()), names = c(\"transplanted\",\"recovered\",\"relapsed.dead\"))\ntmat\n\n               to\nfrom            transplanted recovered relapsed.dead\n  transplanted            NA         1             2\n  recovered               NA        NA             3\n  relapsed.dead           NA        NA            NA\n\n\nTo perform the estimation, we need to convert the data-frame to a long format, where there are 2-3 lines for each patient:\n\nbonemarrow.long = msprep(time=c(NA,\"TP\",\"T2\"), status=c(NA,\"P\",\"DF\"),data=bonemarrow,trans=tmat)\nbonemarrow.long %&gt;% as_tibble()\n\n# A tibble: 394 × 8\n      id  from    to trans Tstart Tstop  time status\n   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;\n 1     1     1     2     1      0    13    13      1\n 2     1     1     3     2      0    13    13      0\n 3     1     2     3     3     13  2081  2068      0\n 4     2     1     2     1      0    18    18      1\n 5     2     1     3     2      0    18    18      0\n 6     2     2     3     3     18  1602  1584      0\n 7     3     1     2     1      0    12    12      1\n 8     3     1     3     2      0    12    12      0\n 9     3     2     3     3     12  1496  1484      0\n10     4     1     2     1      0    13    13      1\n# ℹ 384 more rows\n\n\n\n# example\nbonemarrow %&gt;% as_tibble() %&gt;% filter(T2 == 383)\n\n# A tibble: 1 × 22\n      g    T1    T2     D     R    DF    TA     A    TC     C    TP     P    Z1\n  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;\n1     1   417   383     1     1     1   417     0   417     0    16     1    15\n# ℹ 9 more variables: Z2 &lt;int&gt;, Z3 &lt;int&gt;, Z4 &lt;int&gt;, Z5 &lt;int&gt;, Z6 &lt;int&gt;,\n#   Z7 &lt;int&gt;, Z8 &lt;int&gt;, Z9 &lt;int&gt;, Z10 &lt;int&gt;\n\n\nThen we fit a stratified Cox-model with no covariates (stratifying on the type of transition), extract the Nelson-Aalen estimates for the cumulative transition intensities and make a plot of these:\n\ncox.bm=coxph(Surv(Tstart,Tstop,status)~strata(trans),data=bonemarrow.long, method=\"breslow\")\nhaz.bm=msfit(cox.bm,trans=tmat)\n\nplot(haz.bm,xlab=\"Days post-transplant\",xlim=c(0,1000),ylim=c(0,3.5))\n\n\n\n\nTo find the Aalen-Johansen estimates of the transition probabilities, we give the command:\n\nprob.bm = probtrans(haz.bm,predt=0)\n\nWe may extract the empirical transition probabilities from state “transplanted” (state 1) by the command prob.bm[[1]], and similarly we obtain the empirical transition probabilities from state “recovered” (state 2) by prob.bm[[2]].\nThe transition probabilities may be plotted in a stacked manner or as separate estimates by the commands:\n\nplot(prob.bm,type=\"filled\",ord=c(2,1,3))\n\n\n\nplot(prob.bm,type=\"filled\")\n\n\n\n\nProbability of being in each state:\n\nplot(prob.bm,type=\"single\",xlim=c(0,1000),col=1:3)\n\n\n\n\n\nPerform the commands given above. Make sure that you understand what each of the commands and plots give you, and compare the results with those of example 3.16 in the ABG-book.\nAbove we used the probtrans command with the option predt=0. This gives transition probabilities from time s = 0 to time t. Also compute and plot the transition probabilities for \\(s = 14, 28\\) and \\(42\\). What can you learn from these plots?\n\n\nprob.bm.14 = probtrans(haz.bm,predt=14)\nplot(prob.bm.14, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 14')\n\n\n\n\n\nprob.bm.28 = probtrans(haz.bm, predt = 28)\nplot(prob.bm.28, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 28')\n\n\n\n\n\nprob.bm.42 = probtrans(haz.bm,predt=42)\nplot(prob.bm.42, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 42')\n\n\n\n\n\nWhat if I start from state 2?\n\n\nplot(prob.bm.14, from = 2, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 14 from 2nd Recovery state')\n\n\n\n\nReference:\n\nKlein, JP and Moeschberger, ML (2003) Survival analysis. Techniques for Censored and Truncated Data (2nd edition). Springer-Verlag, New York."
  },
  {
    "objectID": "frailty.html",
    "href": "frailty.html",
    "title": "Frailty models for clustered data",
    "section": "",
    "text": "library(survival)\nlibrary(parfm)\nlibrary(tibble)\nlibrary(dplyr)\n\nThe Diabetic Retinopathy Study was conducted in the US by the National Eye Institute to assess the effect of laser photocoagulation in delaying onset of severe visual loss (“blindness”) in patients with diabetic retinopathy. One eye of each patient was randomly selected for photocoagulation and the other was observed without treatment. The patients were followed over several years for the occurrence of blindness (event = blindness) in their left and right eyes. Censoring is caused by death, dropout, or end of the study. We consider only a subset of the original data set containing \\(197\\) high risk patients. See Huster et al, 1989, Biometrics, for a discussion and further references.\nThere are two lines for each patient in the data set: one line per eye. The variables are:\n\nid: patient number\ntrteye: treated eye (1=right, 2=left)\nageonset: age at diagnosis of diabetes\ntypediab: type of diabetes (1= juvenile age at onset &lt; 20 years , 2=adult)\ntime: follow-up time in months\nstatus: status for eye (0=censored, 1=blindness)\ntrt: treatment of eye (1=control eye, 2=treated eye)\n\nBefore you start, you will have to read the data. Use the R-command:\n\neye=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/retinopathy.txt\", header=T) %&gt;% as_tibble()\neye\n\n# A tibble: 394 × 7\n      id trteye ageonset typediab status  time   trt\n   &lt;int&gt;  &lt;int&gt;    &lt;int&gt;    &lt;int&gt;  &lt;int&gt; &lt;dbl&gt; &lt;int&gt;\n 1     5      2       28        2      0 46.2      1\n 2    14      1       12        1      1 31.3      1\n 3    16      1        9        1      0 42.3      1\n 4    25      2        9        1      0 20.6      1\n 5    29      2       13        1      1  0.3      1\n 6    46      1       12        1      1 54.3      1\n 7    49      1        8        1      1 10.8      1\n 8    56      1       12        1      0 23.2      1\n 9    61      1       16        1      0  1.47     1\n10    71      1       21        2      1 13.8      1\n# ℹ 384 more rows\n\n\nWe start out by only using treatment as a covariate.\n\nWe first fit a model with Weibull baseline and no frailty by the command:\n\n\nnofrail.model = parfm(Surv(time,status)~factor(trt),data=eye)\nnofrail.model\n\n\nFrailty distribution: none \nBaseline hazard distribution: Weibull \nLoglikelihood: -836.379 \n\n             ESTIMATE SE    p-val    \nrho           0.810   0.058          \nlambda        0.032   0.008          \nfactor(trt)2 -0.790   0.169 &lt;.001 ***\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\nci.parfm(nofrail.model)\n\n               low    up\nfactor(trt)2 0.326 0.632\n\n\nPerform the command, and make sure that you understand what the output tells you.\n\nWe then fit a model with Weibull baseline and gamma frailty:\n\n\nfrail.model = parfm(Surv(time,status)~factor(trt),cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model\n\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.744 \n\n             ESTIMATE SE    p-val    \ntheta         1.040   0.329          \nrho           0.948   0.075          \nlambda        0.028   0.007          \nfactor(trt)2 -0.960   0.182 &lt;.001 ***\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.342 \n\n\nPerform the command, and compare with the result for the model without frailty. Is there a significant frailty effect?\n\nLR=2*(attributes(frail.model)$loglik - attributes(nofrail.model)$loglik)\nLR\n\n[1] 17.26943\n\n(1-pchisq(LR, 1))/2 # YES!\n\n[1] 1.621814e-05\n\n\n\nSignificant risk variation between the clusters (individuals here)!\n\n\nFit a model with gamma frailty and treatment and age at onset as covariates. Is there a significant effect of age at onset? What about type of diabetes?\n\n\nfrail.model.ageonset = parfm(Surv(time,status)~factor(trt) + ageonset, cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model.ageonset # NO! (coef close to 0, p-value large)\n\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.469 \n\n             ESTIMATE SE    p-val    \ntheta         1.034   0.328          \nrho           0.948   0.075          \nlambda        0.025   0.008          \nfactor(trt)2 -0.966   0.182 &lt;.001 ***\nageonset      0.006   0.008 0.456    \n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.341 \n\nfrail.model.typediab = parfm(Surv(time,status)~factor(trt) + factor(typediab), cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model.typediab # NO! (coef close to 0, p-value large)\n\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.73 \n\n                  ESTIMATE SE    p-val    \ntheta              1.037   0.329          \nrho                0.947   0.075          \nlambda             0.028   0.008          \nfactor(trt)2      -0.961   0.182 &lt;.001 ***\nfactor(typediab)2  0.040   0.232 0.864    \n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.341 \n\n\n\nFit a Cox frailty model (with gamma frailty) using treatment as the only covariate (see lectures for R commands). Compare the results with those you obtained in question b.\n\n\nfrail.cox = coxph(Surv(time,status) ~ factor(trt) + frailty(id), data=eye)\nfrail.cox\n\nCall:\ncoxph(formula = Surv(time, status) ~ factor(trt) + frailty(id), \n    data = eye)\n\n                coef se(coef)     se2   Chisq   DF       p\nfactor(trt)2  -0.910    0.174   0.171  27.295  1.0 1.7e-07\nfrailty(id)                           114.448 84.6   0.017\n\nIterations: 6 outer, 30 Newton-Raphson\n     Variance of random effect= 0.854   I-likelihood = -850.9 \nDegrees of freedom for terms=  1.0 84.6 \nLikelihood ratio test=201  on 85.6 df, p=3e-11\nn= 394, number of events= 155 \n\n\n\n# cox with no frailty\ncox = coxph(Surv(time, status) ~ factor(trt), data = eye)\n\nLRcox = 2*(frail.cox$history$frailty$c.loglik - cox$loglik[2])\nLRcox # log-likelihood ratio\n\n[1] 11.88032\n\n1 - pchisq(LRcox,df=1)\n\n[1] 0.0005673029\n\n\n\nFinally we want to illustrate how stratified Cox regression can be used to analyse paired survival data like the ones we have in the present situation. We may fit a stratified Cox model with a separate baseline for each patient (per eye pair pretty much) by the commands:\n\n\neyefit.strat=coxph(Surv(time,status)~trt+strata(id),data=eye)\nsummary(eyefit.strat)\n\nCall:\ncoxph(formula = Surv(time, status) ~ trt + strata(id), data = eye)\n\n  n= 394, number of events= 155 \n\n       coef exp(coef) se(coef)      z Pr(&gt;|z|)    \ntrt -0.9623    0.3820   0.2016 -4.773 1.82e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\ntrt     0.382      2.618    0.2573    0.5672\n\nConcordance= 0.748  (se = 0.058 )\nLikelihood ratio test= 25.49  on 1 df,   p=4e-07\nWald test            = 22.78  on 1 df,   p=2e-06\nScore (logrank) test = 24.59  on 1 df,   p=7e-07\n\n\nExplain the idea behind such an approach, and discuss how it compares to the approach in question d).\nWe got same approximately results! Why? See equation (slide no. 24): \\(a_{ij}(t|Z_i) = Z_i a_0(t) e^{\\beta x_{ij}}\\)\n\nCox model uses different baseline hazards per stratum (\\(Z_i=1\\))\nParametric Frailty models are better in most practical applications (\\(a_0(t)\\) same for all individuals, \\(Z_i\\) varies and is estimated)"
  },
  {
    "objectID": "ncc.html",
    "href": "ncc.html",
    "title": "Case-control studies",
    "section": "",
    "text": "library(survival)\nlibrary(glmnet)\nlibrary(tibble)\nlibrary(dplyr)\n\nIn this exercise we will use data from a cohort of \\(1720\\) female patients who were discharged from two tuberculosis sanatoria in Massachusetts between 1930 and 1956 to investigate breast cancer risk of radiation exposure due to fluoroscopy. Radiation doses have been estimated for \\(1022\\) women who received radiation exposure to the chest from X-ray fluoroscopy lung examinations. Some women had multiple exposures to radiation. The remaining \\(698\\) women in the cohort received treatments that did not require fluoroscopic monitoring and were radiation unexposed. The patients had been followed up until the end of 1980, by which time \\(75\\) breast cancer cases were observed. (Source: Hrubec et al., Cancer Research, 1989)\nFor this cohort radiation data have been collected for all \\(1720\\) women. But the workload of exposure data collection would have been reduced if the investigators had used a cohort sampling design. In this exercise we will look at estimation based on the full cohort and for nested case-control and case-cohort samples selected from the full cohort.\nWe first look at the cohort data. You may read these data into R by the command\n\ncohort=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/radiationbreast.cohort.txt\", header=T) %&gt;% as_tibble()\ncohort\n\n# A tibble: 1,720 × 6\n      id   dose number ageentry ageexit status\n   &lt;int&gt;  &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;int&gt;\n 1     1 0           0     14.6    47.4      0\n 2     2 0           0     14.2    52.6      0\n 3     3 0           0     17.5    69.8      0\n 4     4 0           0     14.0    46.3      0\n 5     5 0           0     16.5    61.7      0\n 6     6 0.0660      4     16.0    58.6      0\n 7     7 1.25      108     13.0    62.3      0\n 8     8 0           0     13.2    53.5      0\n 9     9 0           0     17.3    42.5      1\n10    10 0.141      32     19.0    22.6      0\n# ℹ 1,710 more rows\n\n\nThe data are organized with one line for each of the 1720 women, and with the following variables in the six columns:\n\nid: subject id\ndose: radiation dose (Gy)\nnumber: number of fluoroscopic examinations\nageentry: age at entry into the study (in years)\nageexit: age at breast cancer or censoring (in years)\nstatus: breast cancer status (0: censored; 1: breast cancer)\n\nTo model the effect of radiation dose on breast cancer risk, we will consider a Cox regression model with \\(log2(dose + 1)\\), with dose measured in grays (Gy), as covariate. You may fit this model for cohort data by the commands:\n\nfit.cohort=coxph(Surv(ageentry,ageexit,status)~log2(dose+1), data=cohort)\nsummary(fit.cohort)\n\nCall:\ncoxph(formula = Surv(ageentry, ageexit, status) ~ log2(dose + \n    1), data = cohort)\n\n  n= 1720, number of events= 75 \n\n                 coef exp(coef) se(coef)     z Pr(&gt;|z|)   \nlog2(dose + 1) 0.4907    1.6335   0.1617 3.035  0.00241 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n               exp(coef) exp(-coef) lower .95 upper .95\nlog2(dose + 1)     1.634     0.6122      1.19     2.243\n\nConcordance= 0.586  (se = 0.034 )\nLikelihood ratio test= 8.64  on 1 df,   p=0.003\nWald test            = 9.21  on 1 df,   p=0.002\nScore (logrank) test = 9.44  on 1 df,   p=0.002\n\n\nWe then consider nested case-control data with two controls per case \\((m=2)\\). You may read these data into R by the command\n\nncc=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/radiationbreast.ncc.txt\", header=T) %&gt;% as_tibble()\nncc\n\n# A tibble: 225 × 8\n      id  dose number ageentry ageexit status setno  case\n   &lt;int&gt; &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt;\n 1     9 0          0    17.3     42.5      1     1     1\n 2  2717 0          0    31.2     83.2      0     1     0\n 3   311 0          0    14.4     61.7      0     1     0\n 4    22 0.617     39    17.2     25.4      1     2     1\n 5    66 0.259     27    11.5     44.8      0     2     0\n 6   401 1.83     111     5.25    51.4      0     2     0\n 7    29 0.594     36    17.7     48.5      1     3     1\n 8  3027 2.63     267    21.5     73.8      0     3     0\n 9  2349 0.807     82    23.4     69.7      0     3     0\n10    31 0          0    12.5     36.6      1     4     1\n# ℹ 215 more rows\n\n\nThe data are organized with three lines for each of the 75 sampled risk sets (one line for the case, and one line for each of the two controls, randomly selected, but falling within the risk set, e.g. the is an overlap between the age interval - think!), and with eight columns. The first six columns are as for the cohort data, while the variables in the two last columns are:\n\ncase: case-control status within the sampled risk set (0=control, 1=case)\nsetno: label of sampled risk set\n\nYou may fit the Cox regression model for the nested case-control data by the commands: Note we use case instead of status and strata(setno) so that only the 3 patients per setno are used for the calculation of the risk set:\n\nfit.ncc = coxph(Surv(ageentry,ageexit,case) ~ log2(dose+1)+strata(setno),data=ncc)\nsummary(fit.ncc)\n\nCall:\ncoxph(formula = Surv(ageentry, ageexit, case) ~ log2(dose + 1) + \n    strata(setno), data = ncc)\n\n  n= 225, number of events= 75 \n\n                 coef exp(coef) se(coef)     z Pr(&gt;|z|)  \nlog2(dose + 1) 0.5404    1.7167   0.2366 2.284   0.0224 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n               exp(coef) exp(-coef) lower .95 upper .95\nlog2(dose + 1)     1.717     0.5825      1.08      2.73\n\nConcordance= 0.563  (se = 0.058 )\nLikelihood ratio test= 5.39  on 1 df,   p=0.02\nWald test            = 5.22  on 1 df,   p=0.02\nScore (logrank) test = 5.39  on 1 df,   p=0.02\n\n\n\nExplain why these commands maximize the partial likelihood for nested case-control data. Perform the commands and compare the result with those you obtained for the cohort data.\n\nWe then consider case-cohort data with a subcohort of \\(150\\) women. You may read these data into R by the command\n\ncaseco=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/radiationbreast.caseco.txt\", header=T) %&gt;% as_tibble()\ncaseco\n\n# A tibble: 218 × 7\n      id  dose number ageentry ageexit status  subc\n   &lt;int&gt; &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;int&gt; &lt;int&gt;\n 1  2133 0          0     33.3    68.6      0     1\n 2  2608 0.826     84     25.8    67.6      0     1\n 3   497 0          0     16.2    60.6      0     1\n 4  2658 1.62     193     24.4    63.7      0     1\n 5  2611 0          0     24.2    68.5      0     1\n 6  3152 0          0     36.5    75.7      0     1\n 7   118 0.974     59     16.3    34.2      0     1\n 8  3352 0          0     27.9    39.3      1     1\n 9  2210 1.51     181     20.8    54.0      0     1\n10   165 0.248     15     10.2    19.1      0     1\n# ℹ 208 more rows\n\n\nThe data are organized with one line for each woman who is in the subcohort or is a cancer case outside the subcohort (no censored patients outside the subcohort!). The \\(150\\) women were randomly selected to be in the subcohort. The rest to reach \\(218\\) were the cases added (\\(status=1\\)) that are not in the subcohort. All the cases (\\(75\\)) are included in the data (as was the case with ncc)! The data file has seven columns. The first six columns are as for the cohort data, while the last column is:\n\nsubc: subcohort status (0: not in subcohort; 1: member of subcohort)\n\nFor case cohort-data there are two possible methods of estimation. You may fit the Cox model for the case-cohort data using Prentice’s method by the commands:\n\nfit.prentice = cch(Surv(ageentry,ageexit,status)~ log2(dose+1), data=caseco, subcoh=~subc, id=~id, method=\"Prentice\", cohort.size=1720)\n\nprint(fit.prentice)\n\nCase-cohort analysis,x$method, Prentice \n with subcohort of 150 from cohort of 1720 \n\nCall: cch(formula = Surv(ageentry, ageexit, status) ~ log2(dose + 1), \n    data = caseco, subcoh = ~subc, id = ~id, cohort.size = 1720, \n    method = \"Prentice\")\n\nCoefficients:\n         Value        SE        Z          p\n[1,] 0.5194255 0.2152382 2.413259 0.01581057\n\nsummary(fit.prentice)\n\nCase-cohort analysis,x$method, Prentice \n with subcohort of 150 from cohort of 1720 \n\nCall: cch(formula = Surv(ageentry, ageexit, status) ~ log2(dose + 1), \n    data = caseco, subcoh = ~subc, id = ~id, cohort.size = 1720, \n    method = \"Prentice\")\n\nCoefficients:\n       Coef    HR  (95%   CI)     p\nValue 0.519 1.681 1.102 2.563 0.016\n\n\n\nPerform the commands and compare the result with those you obtained for cohort data and nested case-control data. Also fit the model using inverse probability weighting (which is achieved by using method=“LinYing”), and compare with the results for Prentice’s method.\n\n\nfit.ipw = survival::cch(Surv(ageentry,ageexit,status)~ log2(dose+1), data=caseco, subcoh=~subc, id=~id, method=\"LinYing\", cohort.size=1720)\n\nsummary(fit.ipw)\n\nCase-cohort analysis,x$method, LinYing \n with subcohort of 150 from cohort of 1720 \n\nCall: survival::cch(formula = Surv(ageentry, ageexit, status) ~ log2(dose + \n    1), data = caseco, subcoh = ~subc, id = ~id, cohort.size = 1720, \n    method = \"LinYing\")\n\nCoefficients:\n       Coef    HR  (95%   CI)     p\nValue 0.524 1.688 1.116 2.555 0.013\n\n\nFinally we consider stratified case-cohort data where the sub-cohort consists of 50 women selected from each of the three strata:\n\nwomen with no fluoroscopic examinations (698 women)\nwomen with 1-149 fluoroscopic examinations (765 women)\nwomen with 150 or more fluoroscopic examinations (257 women)\n\nYou may read the stratified case-cohort data into R by the command:\n\nstratcaseco=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/radiationbreast.stratcaseco.txt\", header=T) %&gt;% as_tibble()\nstratcaseco\n\n# A tibble: 221 × 8\n      id  dose number ageentry ageexit status  subc stratum\n   &lt;int&gt; &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt;\n 1  2894     0      0     29.3    39.8      0     1       1\n 2  2885     0      0     40.6    76.4      0     1       1\n 3  2490     0      0     18.3    40.9      0     1       1\n 4  2717     0      0     31.2    83.2      0     1       1\n 5  3015     0      0     29.7    60.4      0     1       1\n 6    73     0      0     16.3    64.6      0     1       1\n 7    44     0      0     17.9    19.5      0     1       1\n 8  3277     0      0     26.1    70.4      0     1       1\n 9  2873     0      0     25.6    62.9      0     1       1\n10  2423     0      0     24.8    62.1      0     1       1\n# ℹ 211 more rows\n\n\nThe data are organized with one line for each woman who is in the subcohort or is a cancer case outside the subcohort. The data file has eight columns. The first six columns are as for the cohort data, while the two last column are\n\nsubc: subcohort status (0: not in subcohrt; 1: member of subcohort)\nstratum: sampling stratum (1: no fluoroscopic examinations; 2: 1-149 examinations; 3: 150 examinations or more)\n\nYou may fit the Cox model for the stratified case-cohort data using inverse probability weighting by the commands:\n\nstratsize=c(698,765,257)\nnames(stratsize)=c(1,2,3)\nfit.ipw2=cch(Surv(ageentry,ageexit,status)~log2(dose+1), data=stratcaseco, subcoh=~subc,id=~id, stratum=~stratum, method=\"II.Borgan\", cohort.size=stratsize)\n# Borgan II method is a generalization of the Lin-Ying estimator for stratified case-control data\nsummary(fit.ipw2)\n\nExposure-stratified case-cohort analysis, II.Borgan method.\n            1   2   3\nsubcohort  71  87  63\ncohort    698 765 257\nCall: cch(formula = Surv(ageentry, ageexit, status) ~ log2(dose + 1), \n    data = stratcaseco, subcoh = ~subc, id = ~id, stratum = ~stratum, \n    cohort.size = stratsize, method = \"II.Borgan\")\n\nCoefficients:\n       Coef    HR  (95%   CI)     p\nValue 0.506 1.658 1.157 2.377 0.006\n\n\n\nPerform the commands and compare the result with those you obtained for case-cohort data with no stratification."
  }
]